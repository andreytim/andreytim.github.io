<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Let Java Collections be primitive</title>
	
	<meta name="description" content="When one does Machine Learning in Java in large scale, it's crucial to have effective data structure implementations on hand. In this post I will introduce the easy-to-use dynamic array implementation of my own, which could be useful for large feature vectors or huge bit lists, for example.">
	
	<meta name="author" content="Andrey Timoshpolsky">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/andreytim">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:andrey.timoshpolsky@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/3cd21333720dfa77f423085c74faf27c?s=35" class="img-circle" />
				Andrey's Thoughts
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-2 sidebar hidden-xs">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
	<h3 class="title">
        <a href="/">Andrey's Thoughts</a>
    </h3>
</br>
	<a href="/">
		<img src="http://www.gravatar.com/avatar/3cd21333720dfa77f423085c74faf27c?s=150" class="img-thumbnail" />
	</a>
</header>
</br>

<div id="bio" class="text-center">
	Nice to see you!</br>Have a good code crafting!</br></br>
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/andreytim">
				<i class="fa fa-github fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://facebook.com/andrey.timoshpolsky">
				<i class="fa fa-facebook fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/shpolsky">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:andrey.timoshpolsky@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
		
		
	</ul>
   </ul>
</div>
<! -- sidebar.html end -->

	</div>

	<div class="col-sm-8 col-sm-offset-2">
		<div class="page-header">
  <h1>Let Java Collections be primitive </h1>
</div>
	
<article>

	<div class="col-sm-13">
	 <span class="post-date">
	   
	   September 
	   7th,
	   
	   2014
	 </span>
	  <div class="article_body">
	  <h3 id="motivation">Motivation</h3>

<p>Not so long ago I decided to create my own Collections <a href="https://github.com/andreytim/jafar/tree/master/prim">library</a> for primitive types in Java.</p>

<p>So, why should anyone care you ask? <br />
Indeed, there’s a couple of really great libraries in Java with the same purpose. <br />
Here is the list of the most popular ones, in my mind:</p>

<ul>
  <li><a href="http://fastutil.di.unimi.it/">fastutil</a></li>
  <li><a href="http://trove.starlight-systems.com/">trove</a></li>
  <li><a href="http://acs.lbl.gov/ACSSoftware/colt/">colt</a></li>
</ul>

<p>I used Colt collections in large scale ML project myself and was quite satisfied with its performance. So, why do I claim that creating something similar could be useful to somebody? The answer is simple. </p>

<p><em>I don’t want IntArrayList with it’s own API.<br />
I don’t want OpenIntIntMaplalala with it’s specific methods.<br />
I want my favorite java.util.ArrayList.<br />
And I want it to be fast and memory efficient for primitive types.</em></p>

<h3 id="discussion">Discussion</h3>

<p><em>People with such impulsive wishes inevitably face problems in the first place.</em> Well, what problems do we have?</p>

<h4 id="first">First.</h4>
<p>How to force Java’s ArrayList to work with primitives and to forget all this boxing/unboxing stuff?
It wouldn’t be a problem if Java has Generics for primitives. Oh, it would be really nice. <em>Ahhrrr…</em> But, it hasn’t.<br />
Furthermore, even if we made our own beautiful class, we wouldn’t have any obvious way to generify it for primitives.
Seems like we are forced to create <code>(Int|Byte|*)ArrayLists</code> till death do us part.</p>

<h4 id="second">Second.</h4>
<p>Let’s imagine that we have found the way to make ArrayList<integer> primitive internally. Cool, now it's much more effective in terms of memory footprint. But the interface List<integer> has no methods working with primitives, only typed ones, furiously demanding Objects and nothing less. How to get rid of this boxing/unboxing overhead?</integer></integer></p>

<p>To be honest, I’ve found some ways to deal with these questions, but, of course, <em>they are rather dirty hacks than smart elegant tricks</em>. Anyway, let me tell you about it.</p>

<h4 id="approach-to-the-first">Approach to the First.</h4>
<p>It’s not hard to reformulate the problem in such way: <em>we need to come up with idea of somehow getting the right primitive array inside of our ArrayList</em>. The word “right” here means “corresponding to the type T of generic class <code>ArrayList&lt;T&gt;</code>”. The problem is that this information will be erased at runtime, as we know, and, actually, there’s no adequate way to learn the true type at the moment of instantiation of ArrayList.</p>

<p>Here goes my observation: <em>we, actually, don’t need to know the parameter type right at the moment of initialization</em>. We only start caring about it at the moment of the first insertion of something to the collection. </p>

<p>And here goes the solution: <em>at the moment of the first insertion we could directly ask the element being inserted for its actual class and lazily initialize the proper internal array of corresponding primitives</em>. As the collection is Generic and was created with corresponding boxed type parameter by the user, the element being inserted will be of the proper boxed type and the internal array will be created in the right manner.</p>

<p>I’ve used just the described approach in <strong>Jafar</strong> but with a tiny modification: <code>JArrayList&lt;T&gt;</code> is just a proxy for the internal primitive <code>JArrayList(Byte|Int|...)</code>. At the moment of insertion it finds and instantiates the internal list of the primitive type corresponding to type parameter <strong>T</strong>. I’ve made it in such way because now we can have completely different implementations of ArrayLists for different primitive types. This capability was utilized to make <code>JArrayList&lt;Boolean&gt;</code> “bitwise” and therefore much more memory efficient.<br />
<br />
<script src="https://gist.github.com/e609c2cd38478d4dec83.js"> </script>
<br />  </p>

<h4 id="approach-to-the-second">Approach to the Second.</h4>
<p>This part is appeared to be a little bit easier but only partially solved. As you could notice above there’s such an interface as <code>JList</code>. This interface extends the common <code>java.util.List</code> adding overloaded mutation methods for each primitive type. For example:<br />
<br />
<script src="https://gist.github.com/7271b79908013ac98c10.js"> </script>
<br />
Now, let’s consider such declaration:<br />
<br />
<code>List&lt;Integer&gt; list = new JArrayList&lt;&gt;();</code><br />
<br />
When you just change there the interface <strong>List</strong> to <strong>JList</strong>, you will automatically change all method calls <code>list.add(i);</code> in your code with primitive actual argument <strong>i</strong> to overloaded versions without the boxing/unboxing redundancy. Thus, you get better performance.  	 
The main flaw of this approach is that we can’t overload method <code>public T get(int idx)</code>, because Java won’t distinguish it from <code>public byte get(int idx)</code>. And this is the place where I couldn’t come up with the trick of staying within the same interface but changing the meaning. Shame on me! </p>

<p>I do provide the specific methods <code>public (byte|int|*) get(Byte|Int|*)(int idx)</code> but, of course, it violates my original dream and is the same thing three libraries from the beginning of this post do.</p>

<p>Another deficiency is that the client could try to invoke the wrong method. For example, he could try to add <strong>byte</strong> value to <code>JList&lt;Character&gt;</code> and the compiler will allow it. In this case he will get an exception of the wrong type at runtime and will be forced to find this bug. But, of course, <a href="http://www.amazon.com/Effective-Java-Edition-Joshua-Bloch/dp/0321356683">J.Bloch</a> would say that this is not right, I think.  </p>

<h3 id="conclusion">Conclusion</h3>

<p>Well, I’ve danced enough around my impulsive wish and seems like I’ve got not only exciting experience but the library of primitive collections, which could be fun to use in general.
<a href="https://github.com/andreytim/jafar/tree/master/prim">Jafar</a> has only dynamic arrays so far, but currently I’m working on similar implementations of Maps and Sets, which are even more popular data structures in large scale tasks than dynamic arrays. And again, we would be able to have specific implementations for different types (<em>not only primitive in general</em>) like Suffix Trees for Strings, for example, which could be great deal for the variety of Information Retrieval tasks.  </p>

<p>I will be glad to any feedback and despite the fact that I’ve tried to cover my mess with unit tests there’re could be bugs, of course. Maybe there’re any other ideas of solving the problems described above and getting me closer to the dream. Feel free to share it with me! That’s interesting, though maybe not so world changing. </p>

<p>In the next post I want to share my experience in benchmarking all this stuff. How I tried a couple of specific frameworks, then made an effort of implementing my own benchmarking library and ended with using the great profiling and benchmarking tool <a href="http://openjdk.java.net/projects/code-tools/jmh/">jmh</a> making the whole thing comfortably functioning in multi-module Gradle project. Also, I’m going to show some numbers comparing Jafar implementations with the ones from libraries mentioned at the beginning of this post. </p>

<p>See you!     </p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#java-ref">
					java <span>(1)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#jafar-ref">
					jafar <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#java-ref">
					java <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#primitive collections-ref">
					primitive collections <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#arraylist-ref">
					arraylist <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#jafar-prim-ref">
					jafar-prim <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Let Java Collections be primitive"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/3cd21333720dfa77f423085c74faf27c" class="img-rounded author-image" />
        <h4 class="section-title author-name">Andrey Timoshpolsky</h4>
        <p class="author-bio">Software Engineer</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous disabled"><a>&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>



		<footer>
			<hr/>
			<p>
				&copy; 2014 Andrey Timoshpolsky with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

